// Generated by CoffeeScript 1.3.3
(function() {
  var cyc;

  cyc = angular.module('cyc', ['ngAnimate']).controller('CycCtrl', [
    '$scope', '$http', function($scope, $http) {
      $scope.init = function() {
        $scope.page = 'home';
        $scope.user = {
          loggedin: false,
          token: ''
        };
      };
      $scope.hash = function(str) {
        var char, hash, i, _i, _ref;
        hash = 0;
        if (str.length === 0) {
          return hash;
        }
        for (i = _i = 0, _ref = str.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
          char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash;
      };
      $scope.blog = function() {
        var codeMirror;
        $scope.page = 'blog';
        codeMirror = CodeMirror(document.getElementById('blog_edit'), {
          mode: 'twilight',
          lineNumbers: true,
          inputStyle: 'textarea',
          viewportMargin: Infinity
        });
      };
      $scope.login = function() {
        var passhash, username;
        username = $('#login-username-field').val();
        passhash = $scope.hash($('#login-password-field').val());
        console.log('login');
        console.log(passhash);
        $http({
          url: '/login',
          method: 'POST',
          data: {
            username: username,
            passhash: passhash
          }
        }).success(function(res) {
          $scope.user['loggedin'] = true;
          $scope.user['token'] = res['response_data']['token'];
          $scope.user['type'] = res['response_data']['user_type'];
          $scope.user['username'] = $('#login-username-field').val();
          $('#login_modal').foundation('reveal', 'close');
          console.log(res);
          console.log('login successful');
        }).error(function(res) {
          console.log(res);
          $scope.user['loggedin'] = false;
          $scope.user['token'] = '';
        });
      };
      $scope.login_modal_trigger = function() {
        $('#login_modal').foundation('reveal', 'open');
      };
      $scope.logout_modal_trigger = function() {
        $('#logout_modal').foundation('reveal', 'open');
      };
      $scope.register_modal_trigger = function() {
        $('#register_modal').foundation('reveal', 'open');
      };
      $scope.logout = function() {
        var data;
        data = {
          username: $scope.user.username,
          token: $scope.user.token
        };
        console.log(data);
        return $http({
          url: '/logout',
          method: 'POST',
          data: data
        }).success(function(res) {
          console.log(res);
          console.log('logout successful');
          $('#logout_modal').foundation('reveal', 'close');
          return $scope.user.loggedin = false;
        }).error(function(res) {
          return alert('logout error');
        });
      };
      $scope.register = function() {
        var data;
        data = {
          username: $('#reg-username-field').val(),
          passhash: $scope.hash($('#reg-password-field').val()),
          email: $('#reg-email-field').val()
        };
        console.log('register');
        console.log(data);
        $http({
          url: '/register',
          method: 'POST',
          data: data
        }).success(function(res) {
          console.log(res);
          console.log('registration successful');
          $scope.user['loggedin'] = true;
          $scope.user['token'] = res['token'];
          $scope.user['username'] = $('#reg-username-field').val();
          $scope.user['type'] = res['user_type'];
          $('#register_modal').foundation('reveal', 'close');
        }).error(function(res) {
          console.log(res);
          $scope.user['loggedin'] = false;
          alert('Failed to register new user!');
        });
      };
      $scope.home = function() {
        return $scope.page = 'home';
      };
      $scope.about = function() {
        $scope.page = 'about';
        $http({
          url: '/about',
          method: 'GET'
        }).success(function(res) {
          console.log(res['text']);
          $scope.about_text = res['text'];
        }).error(function(res) {
          console.log(res);
        });
      };
      return $scope.history = function() {
        $scope.page = 'history';
        $http({
          url: '/history',
          method: 'GET'
        }).success(function(res) {
          console.log(res['text']);
          $scope.history_text = res['text'];
        }).error(function(res) {
          console.log(res);
        });
      };
    }
  ]);

}).call(this);
